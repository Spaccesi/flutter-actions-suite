name: Build ios app
description: Build the iOS app using Flutter
inputs:
  ios-signing-certificate-base64:
    description: "Base64 encoded iOS signing certificate (p12 file)"
    required: true
  build-mode:
    description: "Build mode for the iOS app (debug, profile, release)"
    required: false
    default: "release"
  flavor:
    description: "Flutter flavor to build (optional)"
    required: false
  dart-define:
    description: "Dart define variables for the Flutter build (optional, format: KEY=VALUE)"
    required: false
  obfuscate:
    description: "Whether to obfuscate the Dart code in release builds (default: false)"
    required: false
  no-pub:
    description: "Whether to skip running 'flutter pub get' before the build (default: false)"
    required: false
  target:
    description: "The main entry-point file of the application (default: lib/main.dart)"
    required: false
  build-number:
    description: "An identifier used as an internal version number. Each build must have a unique identifier to differentiate it from previous builds. It is used to determine whether one build is more recent than another, with higher numbers indicating more recent build. On Android it is used as 'versionCode'. On Xcode builds it is used as 'CFBundleVersion'. On Windows it is used as the build suffix for the product and file versions."
    required: false
  build-name:
    description: "A 'x.y.z' string used as the version number shown to users. For each new version of your app, you will provide a version number to differentiate it from previous versions. On Android it is used as 'versionName'. "
    required: false
  code-sign:
    description: "Whether to codesign the application bundle (only available on device builds, default: true)"
    required: false
    default: "true"

 
runs:  
  using: "composite"
  steps:
    - name: Download iOS signing certificate
      id: ios_signing_certificate
      uses: timheuer/base64-to-file@v1
      with:
        fileName: ios-signing-certificate.p12
        encodedString: ${{ inputs.ios-signing-certificate-base64 }} 
    
    - name: Build iOS app
      shell: bash
      run: |
        flutter build ipa --${{ inputs.build-mode }} \
          ${ inputs.flavor && "--flavor " + inputs.flavor } \
          ${ inputs.dart-define && "--dart-define " + inputs.dart-define } \
          ${ inputs.obfuscate == "false" && "--no-obfuscate" } \
          ${ inputs.no-pub == "true" && "--no-pub" } \
          ${ inputs.target && "--target " + inputs.target } \
          ${ inputs.build-number && "--build-number " + inputs.build-number } \
          ${ inputs.build-name && "--build-name " + inputs.build-name } \
          ${ inputs.code-sign == "false" && "--no-codesign" }