name: 'Flutter Actions Suite'
description: 'Builds a Flutter app for iOS, Android, Web, and Desktop, and deploys it.'
author: 'Spaccesi'
branding:
  icon: 'layers'
  color: 'blue'

inputs:
  # Flutter configuration inputs
  flutter-version:
    description: 'The Flutter version to use.'
    required: false
    default: ''
  flutter-channel:
    description: 'The Flutter channel to use (stable, beta, dev, master).'
    required: false
    default: 'stable'

  # Prepare step inputs
  run-build-runner:
    description: 'Whether to run build_runner for code generation. This will run build_runner for all packages in the repository that have a build.yaml file.'
    required: false
    default: 'true'
  run-gen-l10n:
    description: 'Whether to run gen-l10n for code generation. This will run gen-l10n for all packages in the repository that have a l10n.yaml or l10n.yml file.'
    required: false
    default: 'true'
  gen-l10n-fails-if-untranslated:
    description: 'Whether to fail the gen-l10n step if untranslated strings are found. This will check for the presence of an untranslated-messages-file in the l10n configuration file and fail if the file is generated and contains untranslated strings.'
    required: false
    default: 'false'

  # Check step inputs
  run-test:
    description: 'Whether to run tests.'
    required: false
    default: 'true'
  run-analyze:
    description: 'Whether to run flutter analyze.'
    required: false
    default: 'true'
  run-license:
    description: 'Whether to check for licenses of dependencies.'
    required: false
    default: 'true'
  run-coverage:
    description: 'Whether to run tests with coverage and generate a coverage report.'
    required: false
    default: 'true'
  analyze-fails-if-infos:
    description: 'Whether to fail the analyze step if info level issues are found.'
    required: false
    default: 'false'
  analyze-fails-if-warnings:
    description: 'Whether to fail the analyze step if warning level issues are found.'
    required: false
    default: 'false'
  compatible-licenses-conf-path:
    description: 'Path to a YAML file containing a list of compatible licenses. Required if license is set to true. The YAML file should have the following format: compatible_licenses: - MIT - BSD-3-Clause - Apache-2.0'
    required: false
    default: ''
  test-create-coverage-badge:
    description: 'Whether to create a coverage badge based on the generated coverage report. The badge will be created in the root of the repository with the name "coverage_badge.svg".'
    required: false
    default: 'false'

  # General Build step inputs
  build-platform:
    description: 'List of platform to build. Be aware some platform builds need to be run on specific OS. Available options: android, ios, web, windows, macos, linux, none.'
    required: true
  publish-destination:
    description: 'List of platforms where to publish the built app. Be aware build needs to be run first and that not every destination is available for every platfomr. Available options: none, github-releases, store, firebase-app-distribution, github-artifacts, github-pages, firebase-hosting.'
    required: true
  build-mode:
    description: 'The build mode to use. Available options: debug, profile, release.'
    required: false
    default: 'release'
  build-name:
    description: 'The build name to use for the app. This is typically used as the version name shown to users. If not set, the version from pubspec.yaml will be used.'
    required: false
  build-number:
    description: 'The build number to use for the app. This is typically used as the internal version number. If not set, the version from pubspec.yaml will be used.'
    required: false
  flavor:
    description: 'The Flutter flavor to build. If not set, the default flavor will be built.'
    required: false
  dart-define:
    description: 'Additional Dart define variables to pass to the Flutter build command. This should be a comma separated list of key=value pairs.'
    required: false

  # Apple Publish step inputs
  apple-api-key-id:
    description: 'Apple API key ID. Required for publishing to App Store Connect.'
    required: false
  apple-api-key-issuer:
    description: 'Apple API key issuer. Required for publishing to App Store Connect.'
    required: false
  apple-api-key-content:
    description: 'Apple API key content. Required for publishing to App Store Connect.'
    required: false
  apple-api-key-issuer-id:
    description: 'Apple API key issuer ID. Required for publishing to App Store Connect.'
    required: false

  # iOS Build & Publish step inputs
  ios-distribution-certificate-base64:
    description: 'Base64 encoded P12 file containing the iOS distribution certificate and private key. Required for building and signing iOS apps.'
    required: false
  ios-distribution-certificate-password:
    description: 'Password for the iOS distribution certificate. Required for building and signing iOS apps.'
    required: false
  ios-provisioning-profile-base64:
    description: 'Base64 encoded provisioning profile for iOS. Required for building and signing iOS apps.'
    required: false

  # macOS Build & Publish step inputs
  macos-distribution-certificate-base64:
    description: 'Base64 encoded P12 file containing the macOS distribution certificate and private key. Required for building and signing macOS apps.'
    required: false
  macos-distribution-certificate-password:
    description: 'Password for the macOS distribution certificate. Required for building and signing macOS apps.'
    required: false
  macos-installer-certificate-base64:
    description: 'Base64 encoded P12 file containing the macOS installer certificate and private key. Required for building and signing macOS apps.'
    required: false
  macos-installer-certificate-password:
    description: 'Password for the macOS installer certificate. Required for building and signing macOS apps.'
    required: false
  macos-provisioning-profile-base64:
    description: 'Base64 encoded provisioning profile for macOS. Required for building and signing macOS apps.'
    required: false

  # Snap Build & Publish step inputs
  snap-store-token:
    description: 'API token for authenticating with the Snap Store. Required for publishing to the Snap Store.'
    required: false

  # Web Build & Publish step inputs
  base-href:
    description: "Overrides the href attribute of the <base> tag in web/index.html. No change is done to web/index.html file if this flag is not provided. The value has to start and end with a slash '/'. For more information: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base"
    required: false
  firebase-service-account-base64:
    description: 'Base64 encoded Firebase service account key (JSON file). Required for publishing to Firebase Hosting.'
    required: false
  firebase-project-id:
    description: 'Firebase project ID to publish to. Required for publishing to Firebase Hosting.'
    required: false
  firebase-hosting-target:
    description: 'Target to publish to. Required for publishing to Firebase Hosting.'
    required: false

  # Github pages
  github-token:
    description: 'Github token'
    required: false

  # Android Build step inputs
  android-store-file-base64:
    description: 'Base64 encoded JKS or PKCS12 file containing the Android signing keystore. Required for building and signing Android apps.'
    required: false
  android-keystore-alias:
    description: 'Alias of the key to use from the Android signing keystore. Required for building and signing Android apps.'
    required: false
  android-keystore-password:
    description: 'Password for the Android signing keystore. Required for building and signing Android apps.'
    required: false
  android-key-password:
    description: 'Password for the key to use from the Android signing keystore. Required for building and signing Android apps.'
    required: false
  android-build-type:
    description: 'The build mode to use when building the Android app. Available options: apk, appbundle. Default is appbundle.'
    required: false
    default: 'appbundle'
  android-local-properties-file:
    description: 'Path to a local.properties file containing the path to the Android SDK. This is required if the Android SDK is not available in the default location on the runner.'
    required: false
  android-playstore-account-key:
    description: 'Base64 encoded JSON key file for the Google Play Store service account. Required for publishing to Google Play Store.'
    required: false

  # Windows Build step inputs
  microsoft-partner-center-tenant-id:
    description: 'Microsoft Partner Center tenant ID. Required for publishing to Microsoft Store.'
    required: false
  microsoft-partner-center-seller-id:
    description: 'Microsoft Partner Center seller ID. Required for publishing to Microsoft Store.'
    required: false
  microsoft-center-client-id:
    description: 'Microsoft Partner Center client ID. Required for publishing to Microsoft Store.'
    required: false
  microsoft-partner-center-client-secret:
    description: 'Microsoft Partner Center client secret. Required for publishing to Microsoft Store.'
    required: false

runs:
  using: 'composite'
  steps:
    # -- Check inputs -----------------------------------------------------
    - name: Validate inputs
      shell: bash
      run: |
        ERRORS=()

        PLATFORM="${{ inputs.build-platform }}"
        DESTINATION="${{ inputs.publish-destination }}"
        BUILD_MODE="${{ inputs.build-mode }}"

        # --- Firebase Hosting: only web is supported ---
        if [ "$DESTINATION" = "firebase-hosting" ]; then
          if [ "$PLATFORM" != "web" ]; then
            ERRORS+=("Firebase Hosting only supports the 'web' platform. Got: '$PLATFORM'.")
          fi
          if [ "${{ inputs.firebase-project-id }}" == "" ]; then
            ERRORS+=("'firebase-project-id' is required when publish-destination is 'firebase-hosting'.")
          fi
        fi

        # --- Firebase App Distribution: web and linux are not supported ---
        if [ "$DESTINATION" = "firebase-app-distribution" ]; then
          if [ "$PLATFORM" != "android" ] && [ "$PLATFORM" != "ios" ]; then
            ERRORS+=("Firebase App Distribution does not support the '$PLATFORM' platform.")
          fi
          if [ -z "${{ inputs.firebase-service-account-base64 }}" ]; then
            ERRORS+=("'firebase-service-account-base64' is required when publish-destination is 'firebase-app-distribution'.")
          fi
        fi

        # --- Android: signing inputs required for release and profile builds ---
        if [ "$PLATFORM" = "android" ] && [ "$BUILD_MODE" != "debug" ]; then
          if [ -z "${{ inputs.android-store-file-base64 }}" ]; then
            ERRORS+=("'android-store-file-base64' is required when building Android in '$BUILD_MODE' mode.")
          fi
          if [ -z "${{ inputs.android-keystore-alias }}" ]; then
            ERRORS+=("'android-keystore-alias' is required when building Android in '$BUILD_MODE' mode.")
          fi
          if [ -z "${{ inputs.android-keystore-password }}" ]; then
            ERRORS+=("'android-keystore-password' is required when building Android in '$BUILD_MODE' mode.")
          fi
          if [ -z "${{ inputs.android-key-password }}" ]; then
            ERRORS+=("'android-key-password' is required when building Android in '$BUILD_MODE' mode.")
          fi
        fi

        # --- iOS: signing certificate required ---
        if [ "$PLATFORM" = "ios" ]; then
          if [ -z "${{ inputs.ios-signing-certificate-base64 }}" ]; then
            ERRORS+=("'ios-signing-certificate-base64' is required when building for iOS.")
          fi
        fi

        # --- License check: config path required ---
        if [ "${{ inputs.run-license }}" = "true" ]; then
          if [ -z "${{ inputs.compatible-licenses-conf-path }}" ]; then
            ERRORS+=("'compatible-licenses-conf-path' is required when 'run-license' is true.")
          fi
        fi

        # --- Runner OS compatibility ---
        RUNNER_OS="${{ runner.os }}"
        if [[ "$PLATFORM" == *"ios"* ]] && [ "$RUNNER_OS" != "macOS" ]; then
          ERRORS+=("Building for 'ios' requires a macOS runner. Current runner OS: '$RUNNER_OS'.")
        fi
        if [[ "$PLATFORM" == *"macos"* ]] && [ "$RUNNER_OS" != "macOS" ]; then
          ERRORS+=("Building for 'macos' requires a macOS runner. Current runner OS: '$RUNNER_OS'.")
        fi
        if [[ "$PLATFORM" == *"windows"* ]] && [ "$RUNNER_OS" != "Windows" ]; then
          ERRORS+=("Building for 'windows' requires a Windows runner. Current runner OS: '$RUNNER_OS'.")
        fi
        if [[ "$PLATFORM" == *"linux"* ]] && [ "$RUNNER_OS" != "Linux" ]; then
          ERRORS+=("Building for 'linux' requires a Linux runner. Current runner OS: '$RUNNER_OS'.")
        fi

        # --- Report all errors ---
        if [ ${#ERRORS[@]} -gt 0 ]; then
          for ERROR in "${ERRORS[@]}"; do
            echo "ðŸš¨ ::error:: $ERROR"
          done
          exit 1
        fi

        echo "âœ… Input validation passed."

    # -- Setup Flutter -----------------------------------------------------
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ inputs.flutter-version }}
        channel: ${{ inputs.flutter-channel }}
        cache: true

    # -- Prepare -----------------------------------------------------
    - name: Prepare Repository
      uses: Spaccesi/flutter-actions-suite/prepare@main
      with:
        run-build-runner: ${{ inputs.run-build-runner }}
        run-gen-l10n: ${{ inputs.run-gen-l10n }}
        gen-l10n-fails-if-untranslated: ${{ inputs.gen-l10n-fails-if-untranslated }}

    # -- Check -----------------------------------------------------
    - name: Run Checks
      uses: Spaccesi/flutter-actions-suite/check@main
      with:
        run-analyze: ${{ inputs.run-analyze }}
        analyze-fails-if-infos: ${{ inputs.analyze-fails-if-infos }}
        analyze-fails-if-warnings: ${{ inputs.analyze-fails-if-warnings }}
        run-license: ${{ inputs.run-license }}
        compatible-licenses-conf-path: ${{ inputs.compatible-licenses-conf-path }}
        run-test: ${{ inputs.run-test }}
        run-coverage: ${{ inputs.run-coverage }}
        create-coverage-badge: ${{ inputs.test-create-coverage-badge }}

    # -- Build --------------------------------------------------------------
    - name: Build android
      if: contains(inputs.build-platform, 'android')
      uses: Spaccesi/flutter-actions-suite/build/android@main
      with:
        android-store-file-base64: ${{ inputs.android-store-file-base64 }}
        android-local-properties-file: ${{ inputs.android-local-properties-file }}
        android-key-alias: ${{ inputs.android-keystore-alias }}
        android-store-password: ${{ inputs.android-keystore-password }}
        android-key-password: ${{ inputs.android-key-password }}
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        flavor: ${{ inputs.flavor }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: ${{ inputs.no-pub }}
        target: ${{ inputs.target }}
        obfuscate: ${{ inputs.obfuscate }}
        build-type: ${{ inputs.android-build-type }}

    - name: Build iOS
      if: contains(inputs.build-platform, 'ios')
      uses: Spaccesi/flutter-actions-suite/build/ios@main
      with:
        ios-distribution-certificate-base64: ${{ inputs.ios-distribution-certificate-base64 }}
        ios-distribution-certificate-password: ${{ inputs.ios-distribution-certificate-password }}
        ios-provisioning-profile-base64: ${{ inputs.ios-provisioning-profile-base64 }}
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        flavor: ${{ inputs.flavor }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: 'true'
        target: ${{ inputs.target }}
        code-sign: ${{ inputs.code-sign }}
        obfuscate: ${{ inputs.obfuscate }}

    - name: Build web
      if: contains(inputs.build-platform, 'web')
      uses: Spaccesi/flutter-actions-suite/build/web@main
      with:
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: 'true'
        target: ${{ inputs.target }}
        wasm: ${{ inputs.wasm }}
        static-assets-url: ${{ inputs.static-assets-url }}
        base-href: ${{ inputs.base-href }}

    - name: Build windows
      if: contains(inputs.build-platform, 'windows')
      uses: Spaccesi/flutter-actions-suite/build/windows@main
      with:
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: 'true'
        target: ${{ inputs.target }}
        obfuscate: ${{ inputs.obfuscate }}

    - name: Build macos
      if: contains(inputs.build-platform, 'macos')
      uses: Spaccesi/flutter-actions-suite/build/macos@main
      with:
        macos-distribution-certificate-base64: ${{ inputs.macos-distribution-certificate-base64 }}
        macos-distribution-certificate-password: ${{ inputs.macos-distribution-certificate-password }}
        macos-installer-certificate-base64: ${{ inputs.macos-installer-certificate-base64 }}
        macos-installer-certificate-password: ${{ inputs.macos-installer-certificate-password }}
        macos-provisioning-profile-base64: ${{ inputs.macos-provisioning-profile-base64 }}
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        flavor: ${{ inputs.flavor }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: 'true'
        target: ${{ inputs.target }}
        obfuscate: ${{ inputs.obfuscate }}

    - name: Build linux
      if: contains(inputs.build-platform, 'linux')
      uses: Spaccesi/flutter-actions-suite/build/linux@main
      with:
        build-mode: ${{ inputs.build-mode }}
        build-name: ${{ inputs.build-name }}
        build-number: ${{ inputs.build-number }}
        dart-define: ${{ inputs.dart-define }}
        no-pub: 'true'
        obfuscate: ${{ inputs.obfuscate }}

    # -- Resolve build output path -------------------------------------------------
    - name: Resolve build output path
      id: resolve-output
      shell: bash
      run: |
        PLATFORM="${{ inputs.build-platform }}"
        MODE="${{ inputs.build-mode }}"
        BUILD_TYPE="${{ inputs.android-build-type }}"
        MODE_CAP="$(echo "${MODE:0:1}" | tr '[:lower:]' '[:upper:]')${MODE:1}"

        case "$PLATFORM" in
          web)     OUTPUT="build/web" ;;
          android)
            if [ "$BUILD_TYPE" = "apk" ]; then
              OUTPUT="build/app/outputs/apk/$MODE/*.apk"
            else
              OUTPUT="build/app/outputs/bundle/$MODE/*.aab"
            fi
            ;;
          ios)     OUTPUT="build/ios/iphoneos/*.ipa" ;;
          windows) OUTPUT="build/windows/x64/runner/$MODE_CAP" ;;
          macos)   OUTPUT="build/macos/Build/Products/$MODE_CAP" ;;
          linux)   OUTPUT="build/linux/x64/$MODE/bundle" ;;
          *)       OUTPUT="" ;;
        esac

        echo "FLUTTER_BUILD_OUTPUT=$OUTPUT" >> $GITHUB_ENV
        echo "Resolved build output path: $OUTPUT"

    # -- Publish Github ------------------------------------------------------------
    - name: Publish to GitHub Releases
      if: contains(inputs.publish-destination, 'github-releases')
      uses: actions/create-release@v1
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}

    - name: Setup Pages
      if: contains(inputs.publish-destination, 'github-pages') && contains(inputs.build-platform, 'web')
      uses: actions/configure-pages@v5
      with:
        enablement: true

    - name: Upload artifact
      if: contains(inputs.publish-destination, 'github-artifact') || contains(inputs.publish-destination, 'github-pages')
      uses: actions/upload-pages-artifact@v3
      with:
        path: ${{ env.FLUTTER_BUILD_OUTPUT }}

    - name: Deploy to GitHub Pages
      if: contains(inputs.publish-destination, 'github-pages') && contains(inputs.build-platform, 'web')
      id: deployment
      uses: actions/deploy-pages@v4

    # -- Publish to firebase ------------------------------------------------------------
    - name: Publish iOS to Firebase App Distribution
      if: contains(inputs.publish-destination, 'firebase-app-distribution') && contains(inputs.build-platform, 'ios')
      uses: Spaccesi/flutter-actions-suite/publish/firebase-app-distribution@main
      with:
        firebase-release-binary-file: ${{ env.FLUTTER_BUILD_OUTPUT }}
        firebase-service-account-base64: ${{ inputs.firebase-service-account-base64 }}
        firebase-app-id: ${{ inputs.firebase-app-id }}
        firebase-groups: ${{ inputs.firebase-groups }}
        firebase-release-notes: ${{ inputs.firebase-release-notes }}

    - name: Publish android to Firebase App Distribution
      if: contains(inputs.publish-destination, 'firebase-app-distribution') && contains(inputs.build-platform, 'android')
      uses: Spaccesi/flutter-actions-suite/publish/firebase-app-distribution@main
      with:
        firebase-service-account-base64: ${{ inputs.firebase-service-account-base64 }}
        firebase-release-binary-file: ${{ env.FLUTTER_BUILD_OUTPUT }}
        firebase-app-id: ${{ inputs.firebase-app-distribution-app-id }}
        firebase-groups: ${{ inputs.firebase-app-distribution-groups }}
        firebase-release-notes: ${{ inputs.firebase-app-distribution-release-notes }}

    - name: Publish to Firebase Hosting
      if: contains(inputs.publish-destination, 'firebase-hosting') && contains(inputs.build-platform, 'web')
      uses: Spaccesi/flutter-actions-suite/publish/firebase-hosting@main
      with:
        firebase-service-account-base64: ${{ inputs.firebase-service-account-base64 }}
        firebase-target: ${{ inputs.firebase-hosting-target }}
        firebase-project-id: ${{ inputs.firebase-project-id }}

    # -- Publish to stores ------------------------------------------------------------
    - name: Deploy to Play Store
      if: contains(inputs.publish-destination, 'store') && contains(inputs.build-platform, 'android')
      uses: Spaccesi/flutter-actions-suite/publish/play-store@main
      with:
        android-package-name: ${{ inputs.play-store-package-name }}
        android-track: ${{ inputs.play-store-track }}
        android-service-account-json-base64: ${{ inputs.play-store-service-account-json-base64 }}
        android-release-files: ${{ env.FLUTTER_BUILD_OUTPUT }}

    - name: Deploy to ios App Store
      if: contains(inputs.publish-destination, 'store') && contains(inputs.build-platform, 'ios')
      uses: Spaccesi/flutter-actions-suite/publish/ios-app-store@main
      with:
        apple-api-key-id: ${{ inputs.apple-api-key-id }}
        apple-api-key-content: ${{ inputs.apple-api-key-content }}
        apple-api-key-issuer-id: ${{ inputs.apple-api-key-issuer-id }}
        apple-app-id: ${{ inputs.apple-app-id }}
        app-version: ${{ inputs.app-store-app-version }}

    - name: Deploy to Microsoft Store
      if: contains(inputs.publish-destination, 'store') && contains(inputs.build-platform, 'windows')
      uses: Spaccesi/flutter-actions-suite/publish/microsoft-store@main
      with:
        microsoft-partner-center-tenant-id: ${{ inputs.microsoft-partner-center-tenant-id }}
        microsoft-partner-center-seller-id: ${{ inputs.microsoft-partner-center-seller-id }}
        microsoft-partner-center-client-id: ${{ inputs.microsoft-partner-center-client-id }}
        microsoft-partner-center-client-secret: ${{ inputs.microsoft-partner-center-client-secret }}
        microsoft-store-app-id: ${{ inputs.microsoft-store-app-id }}

    - name: Deploy to Mac App Store
      if: contains(inputs.publish-destination, 'store') && contains(inputs.build-platform, 'macos')
      uses: Spaccesi/flutter-actions-suite/publish/macos-app-store@main
      with:
        apple-api-key-id: ${{ inputs.macos-app-store-apple-id }}
        apple-api-key-issuer-id: ${{ inputs.macos-app-store-apple-issuer-id }}
        apple-api-key-content: ${{ inputs.macos-app-store-apple-key-content }}
        macos-provisioning-profile-base64: ${{ inputs.macos-app-store-macos-provisioning-profile-base64 }}

    - name: Deploy to Linux App Store
      if: contains(inputs.publish-destination, 'store') && contains(inputs.build-platform, 'linux')
      uses: Spaccesi/flutter-actions-suite/publish/snap-store@main
      with:
        snap-store-token: ${{ inputs.snap-store-token }}
